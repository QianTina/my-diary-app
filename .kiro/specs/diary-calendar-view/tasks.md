# 实施计划: 日历视图功能

## 概述

本实施计划将日历视图功能分解为增量式的编码任务。每个任务都建立在前一个任务的基础上，确保核心功能尽早通过代码验证。任务按照以下顺序组织：基础设置 → 核心组件 → 数据处理 → 交互功能 → 测试 → 集成。

## 任务

- [x] 1. 设置路由和基础页面结构
  - 在路由配置中添加 `/calendar` 路由
  - 创建 `src/pages/CalendarPage.tsx` 基础组件
  - 在侧边栏导航中添加日历图标和链接
  - 确保路由受身份验证保护
  - _需求: 11.1, 11.2, 11.3, 11.4, 11.5_

- [x] 2. 实现核心类型定义和工具函数
  - [x] 2.1 创建类型定义文件 `src/types/calendar.ts`
    - 定义 `AggregatedDayData`, `ColorIntensity`, `MonthlyStats` 等类型
    - _需求: 1.1, 2.2, 7.1_
  
  - [x] 2.2 实现日期工具函数 `src/utils/calendarUtils.ts`
    - 实现 `formatDateKey`, `formatMonthKey` 函数
    - 实现 `calculateColorIntensity` 函数
    - 实现 `getMoodEmoji` 函数
    - _需求: 2.2, 3.1_
  
  - [ ]* 2.3 为颜色强度计算编写属性测试
    - **属性 3: 颜色强度计算**
    - **验证需求: 2.2**

- [x] 3. 实现数据聚合逻辑
  - [x] 3.1 实现 `aggregateEntriesByDate` 函数
    - 按日期分组日记条目
    - 计算每日条目数量
    - 确定主要心情
    - 计算颜色强度
    - _需求: 9.2, 2.2, 3.2_
  
  - [x] 3.2 实现 `getMostCommonMood` 函数
    - 统计心情出现次数
    - 返回最常见的心情
    - _需求: 3.2_
  
  - [ ]* 3.3 为数据聚合编写属性测试
    - **属性 9: 数据聚合正确性**
    - **验证需求: 9.2**
  
  - [ ]* 3.4 为最常见心情选择编写属性测试
    - **属性 5: 最常见心情选择**
    - **验证需求: 3.2**

- [x] 4. 实现月度统计计算
  - [x] 4.1 实现 `calculateMonthlyStats` 函数
    - 计算总条目数
    - 计算活跃天数
    - 统计心情分布
    - _需求: 7.1, 7.2_
  
  - [x] 4.2 实现 `calculateStreaks` 函数
    - 计算当前连续天数
    - 计算最长连续天数
    - _需求: 7.1_
  
  - [ ]* 4.3 为连续天数计算编写属性测试
    - **属性 12: 连续天数计算正确性**
    - **验证需求: 7.2**
  
  - [ ]* 4.4 编写月度统计单元测试
    - 测试空数据情况
    - 测试单条目情况
    - 测试多条目情况
    - _需求: 7.1, 7.2_

- [x] 5. 实现 CalendarCell 组件
  - [x] 5.1 创建 `src/components/calendar/CalendarCell.tsx`
    - 渲染日期数字
    - 应用颜色强度样式
    - 显示心情图标（如果有）
    - 处理点击事件
    - 显示悬停提示
    - 添加ARIA标签
    - _需求: 1.3, 1.4, 1.5, 2.1, 2.2, 2.3, 3.1, 10.1, 10.4_
  
  - [ ]* 5.2 编写 CalendarCell 单元测试
    - 测试日期显示
    - 测试颜色强度类名
    - 测试心情图标显示
    - 测试点击处理
    - 测试ARIA标签
    - _需求: 1.3, 2.2, 3.1, 10.1_

- [x] 6. 实现 CalendarGrid 组件
  - [x] 6.1 创建 `src/components/calendar/CalendarGrid.tsx`
    - 生成日历网格（7列 x N行）
    - 渲染星期标题
    - 渲染日期单元格
    - 标记其他月份的日期
    - 标记今天的日期
    - _需求: 1.1, 1.3, 1.4, 1.5_
  
  - [ ]* 6.2 为日历日期完整性编写属性测试
    - **属性 1: 日历日期完整性**
    - **验证需求: 1.3**
  
  - [ ]* 6.3 为其他月份日期标记编写属性测试
    - **属性 2: 其他月份日期标记**
    - **验证需求: 1.4**
  
  - [ ]* 6.4 编写 CalendarGrid 单元测试
    - 测试网格结构（7列）
    - 测试星期标题
    - 测试今天日期突出显示
    - _需求: 1.1, 1.5_

- [ ] 7. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

- [x] 8. 实现 CalendarHeader 组件
  - [x] 8.1 创建 `src/components/calendar/CalendarHeader.tsx`
    - 显示月份/年份标题
    - 实现"上个月"按钮
    - 实现"下个月"按钮
    - 实现"今天"按钮
    - 根据当前月份禁用"今天"按钮
    - _需求: 1.2, 5.1, 5.2, 5.3, 6.1, 6.4_
  
  - [ ]* 8.2 编写 CalendarHeader 单元测试
    - 测试月份/年份显示
    - 测试导航按钮点击
    - 测试"今天"按钮状态
    - _需求: 1.2, 5.1, 6.1_

- [x] 9. 实现 MonthlyStats 组件
  - [x] 9.1 创建 `src/components/calendar/MonthlyStats.tsx`
    - 显示总条目数卡片
    - 显示当前连续天数卡片
    - 显示活跃天数卡片
    - 显示心情分布列表
    - 使用图标增强可读性
    - _需求: 7.1, 7.2_
  
  - [ ]* 9.2 编写 MonthlyStats 单元测试
    - 测试统计数据显示
    - 测试心情分布渲染
    - 测试空数据状态
    - _需求: 7.1_

- [x] 10. 实现 EntryModal 组件
  - [x] 10.1 创建 `src/components/calendar/EntryModal.tsx`
    - 显示模态框覆盖层
    - 显示选定日期标题
    - 渲染条目列表
    - 显示每条条目的标题、摘要、心情、标签、时间
    - 实现条目点击导航
    - 实现关闭按钮
    - 实现点击外部关闭
    - 显示空状态和"写日记"按钮
    - 添加ARIA标签和键盘支持
    - _需求: 4.2, 4.3, 4.4, 4.5, 4.6, 10.1, 10.2_
  
  - [ ]* 10.2 为Modal条目信息完整性编写属性测试
    - **属性 7: Modal条目信息完整性**
    - **验证需求: 4.3**
  
  - [ ]* 10.3 编写 EntryModal 单元测试
    - 测试条目列表渲染
    - 测试空状态显示
    - 测试关闭功能
    - 测试键盘导航
    - _需求: 4.2, 4.3, 4.6, 10.2_

- [x] 11. 实现 CalendarPage 主组件
  - [x] 11.1 实现状态管理
    - 定义所有状态变量（currentMonth, entries, aggregatedData等）
    - 实现月份缓存逻辑
    - _需求: 9.5, 9.6_
  
  - [x] 11.2 实现数据获取函数 `fetchMonthData`
    - 检查缓存
    - 从Supabase查询月度数据
    - 处理加载和错误状态
    - 更新缓存
    - _需求: 9.1, 9.3, 9.4, 9.5_
  
  - [x] 11.3 实现月份导航处理函数
    - `handlePreviousMonth`
    - `handleNextMonth`
    - `handleToday`
    - _需求: 5.2, 5.3, 6.2_
  
  - [x] 11.4 实现日期选择处理函数
    - `handleDateClick`
    - `handleCloseModal`
    - _需求: 4.1, 4.5_
  
  - [x] 11.5 组装所有子组件
    - 渲染 CalendarHeader
    - 渲染 CalendarGrid
    - 渲染 MonthlyStats
    - 渲染 EntryModal（条件渲染）
    - 显示加载和错误状态
    - _需求: 1.1, 9.3, 9.4_
  
  - [ ]* 11.6 为月份缓存一致性编写属性测试
    - **属性 10: 月份缓存一致性**
    - **验证需求: 9.5, 9.6**
  
  - [ ]* 11.7 为月份导航往返一致性编写属性测试
    - **属性 8: 月份导航往返一致性**
    - **验证需求: 5.2, 5.3, 5.4**

- [ ] 12. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

- [x] 13. 实现样式和主题支持
  - [x] 13.1 创建 `src/styles/calendar.css`
    - 定义CSS变量（浅色和深色主题）
    - 实现日历网格布局
    - 实现颜色强度样式
    - 实现响应式断点（移动、平板、桌面）
    - 实现悬停和焦点状态
    - _需求: 1.6, 2.4, 8.1, 8.2, 8.3, 8.5, 8.6_
  
  - [x] 13.2 确保可访问性样式
    - 焦点指示器
    - 颜色对比度
    - 触摸目标大小（移动端）
    - _需求: 10.3, 10.5_

- [x] 14. 实现错误处理和边缘情况
  - [x] 14.1 添加错误边界组件
    - 捕获组件错误
    - 显示友好的错误消息
    - _需求: 9.4_
  
  - [x] 14.2 实现认证检查
    - 检查用户会话
    - 重定向未登录用户
    - _需求: 11.5_
  
  - [x] 14.3 实现数据加载错误处理
    - 显示错误消息
    - 提供重试按钮
    - 记录错误到控制台
    - _需求: 9.4_
  
  - [ ]* 14.4 编写错误处理单元测试
    - 测试API失败场景
    - 测试认证失败场景
    - 测试重试功能
    - _需求: 9.4, 11.5_

- [ ] 15. 实现性能优化
  - [x] 15.1 添加组件记忆化
    - 使用 React.memo 包装 CalendarCell
    - 使用 useMemo 缓存聚合数据
    - 使用 useCallback 缓存事件处理函数
    - _需求: 9.5_
  
  - [x] 15.2 实现导航防抖
    - 防止快速点击导致多次API调用
    - _需求: 5.2, 5.3_
  
  - [x] 15.3 添加懒加载
    - 使用 React.lazy 懒加载 CalendarPage
    - _需求: 9.1_

- [ ] 16. 集成测试和端到端验证
  - [ ]* 16.1 编写集成测试
    - 测试完整的日期选择流程
    - 测试月份导航流程
    - 测试数据加载和缓存
    - _需求: 4.1, 4.2, 5.2, 5.3, 9.5_
  
  - [ ]* 16.2 为日期选择触发编写属性测试
    - **属性 6: 日期选择触发**
    - **验证需求: 4.1, 4.2**
  
  - [ ]* 16.3 为可访问性标签完整性编写属性测试
    - **属性 11: 可访问性标签完整性**
    - **验证需求: 10.1, 10.4, 10.6**

- [ ] 17. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户
  - 验证所有需求已实现
  - 验证响应式设计在不同设备上工作正常
  - 验证深色/浅色主题切换正常
  - 验证可访问性功能正常

## 注意事项

- 标记为 `*` 的任务是可选的，可以跳过以加快MVP开发
- 每个任务都引用了具体的需求以便追溯
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边缘情况
- 所有属性测试应配置为至少运行100次迭代
- 使用 fast-check 库进行基于属性的测试
- 使用 Vitest 和 React Testing Library 进行单元测试
