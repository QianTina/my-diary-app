# 实施计划: 日记搜索功能

## 概述

本实施计划将日记搜索功能分解为增量式的编码任务。每个任务都建立在前一个任务的基础上，确保核心功能通过代码早期验证。实施将使用TypeScript、React和Supabase。

## 任务

- [x] 1. 设置搜索服务和数据访问层
  - 创建`src/services/searchService.ts`文件
  - 实现`SearchService`接口和基本方法
  - 实现Supabase查询构建器（`buildQuery`方法）
  - 实现用户数据隔离逻辑（RLS支持）
  - 添加TypeScript类型定义（`SearchFilters`、`DateRange`等）
  - _需求: 1.1, 1.5, 16.1, 16.2_

- [ ]* 1.1 为搜索服务编写属性测试
  - **属性 4: 用户数据隔离**
  - **验证: 需求 1.5, 16.1, 16.2**

- [x] 2. 实现搜索历史功能
  - 在`searchService.ts`中实现`saveToHistory`方法
  - 实现`getHistory`方法（从localStorage读取）
  - 实现`clearHistory`方法
  - 实现去重逻辑（移动重复项到顶部）
  - 实现10项限制逻辑
  - 实现用户特定的localStorage键（包含用户ID）
  - _需求: 6.1, 6.2, 6.4, 6.5, 6.6_

- [ ]* 2.1 为搜索历史编写属性测试
  - **属性 14: 搜索历史持久化**
  - **验证: 需求 6.1, 6.2**

- [ ]* 2.2 为搜索历史限制编写属性测试
  - **属性 15: 搜索历史限制**
  - **验证: 需求 6.4**

- [ ]* 2.3 为搜索历史去重编写属性测试
  - **属性 16: 搜索历史去重**
  - **验证: 需求 6.5**

- [ ]* 2.4 为用户历史隔离编写属性测试
  - **属性 17: 用户特定历史隔离**
  - **验证: 需求 6.6**

- [x] 3. 实现文本高亮和格式化工具
  - 在`searchService.ts`中实现`highlightMatches`方法
  - 实现正则表达式转义函数
  - 实现内容截断函数（150字符 + 省略号）
  - 处理多词查询的高亮
  - _需求: 8.2, 8.4_

- [ ]* 3.1 为文本高亮编写属性测试
  - **属性 22: 搜索词高亮**
  - **验证: 需求 8.2**

- [ ]* 3.2 为内容截断编写属性测试
  - **属性 23: 内容截断**
  - **验证: 需求 8.4**

- [x] 4. 创建SearchBar组件
  - 创建`src/components/SearchBar.tsx`文件
  - 实现搜索输入框UI
  - 实现搜索图标和清除按钮
  - 实现防抖逻辑（300ms，使用lodash.debounce或自定义hook）
  - 实现搜索历史下拉显示
  - 实现聚焦时显示历史记录
  - 实现历史项点击处理
  - 实现Escape键清除输入
  - 添加ARIA标签和可访问性属性
  - _需求: 1.4, 6.2, 6.3, 11.3, 14.1_

- [ ]* 4.1 为防抖功能编写属性测试
  - **属性 3: 防抖延迟执行**
  - **验证: 需求 1.4, 15.1**

- [ ]* 4.2 为Escape键清除编写单元测试
  - **属性 28: Escape键清除输入**
  - **验证: 需求 11.3**

- [x] 5. 创建AdvancedFilters组件
  - 创建`src/components/AdvancedFilters.tsx`文件
  - 实现可折叠面板UI（展开/折叠状态）
  - 实现切换按钮和活动过滤器计数徽章
  - 创建TagSelector子组件（多选复选框）
  - 创建MoodSelector子组件（单选按钮组）
  - 创建DateRangePicker子组件（起始和结束日期输入）
  - 实现日期范围验证（起始 ≤ 结束）
  - 实现响应式布局（桌面：内联面板，移动：模态/抽屉）
  - 添加ARIA标签和键盘导航支持
  - _需求: 2.1, 2.4, 3.1, 3.4, 4.1, 4.2, 4.3, 4.4, 7.1, 7.2, 7.3, 7.4, 7.5, 12.2, 12.3_

- [ ]* 5.1 为标签过滤编写属性测试
  - **属性 5: 标签过滤交集**
  - **验证: 需求 2.1**

- [ ]* 5.2 为心情过滤编写属性测试
  - **属性 8: 心情过滤精确匹配**
  - **验证: 需求 3.1**

- [ ]* 5.3 为单一心情选择编写属性测试
  - **属性 9: 单一心情选择约束**
  - **验证: 需求 3.4**

- [ ]* 5.4 为日期范围过滤编写属性测试
  - **属性 10: 日期范围过滤**
  - **验证: 需求 4.1, 4.2, 4.3**

- [ ]* 5.5 为无效日期范围编写属性测试
  - **属性 11: 无效日期范围拒绝**
  - **验证: 需求 4.4**

- [ ]* 5.6 为高级过滤器切换编写单元测试
  - **属性 18: 高级过滤器切换**
  - **验证: 需求 7.2**

- [ ]* 5.7 为折叠时保留过滤器编写属性测试
  - **属性 19: 折叠时保留过滤器**
  - **验证: 需求 7.4**

- [ ]* 5.8 为活动过滤器计数编写属性测试
  - **属性 20: 活动过滤器计数显示**
  - **验证: 需求 7.5**

- [x] 6. 创建或扩展DiaryEntryCard组件
  - 检查是否存在现有的`DiaryEntryCard`组件
  - 如果存在，扩展以支持`highlightQuery` prop
  - 如果不存在，创建`src/components/DiaryEntryCard.tsx`
  - 实现卡片布局（标题、内容预览、日期、标签、心情、位置）
  - 实现高亮文本渲染（使用`dangerouslySetInnerHTML`或安全的高亮组件）
  - 实现内容截断显示
  - 实现点击处理（导航到详情页）
  - 确保响应式设计和主题支持
  - 添加ARIA标签和键盘支持
  - _需求: 8.1, 8.2, 8.3, 8.4_

- [ ]* 6.1 为结果卡片信息完整性编写属性测试
  - **属性 21: 结果卡片完整信息**
  - **验证: 需求 8.1**

- [x] 7. 创建SearchResults组件
  - 创建`src/components/SearchResults.tsx`文件
  - 实现结果计数显示
  - 实现结果列表渲染（使用DiaryEntryCard）
  - 实现加载骨架屏
  - 实现空状态UI（无结果、无条目两种情况）
  - 实现虚拟化（使用react-window或react-virtualized，当结果>100时）
  - 实现结果排序（按日期降序）
  - 添加ARIA live region用于结果计数宣布
  - _需求: 5.2, 5.3, 5.5, 8.5, 9.1, 9.2, 9.3, 9.4, 14.3, 15.3_

- [ ]* 7.1 为加载状态管理编写属性测试
  - **属性 12: 加载状态管理**
  - **验证: 需求 5.2, 5.3**

- [ ]* 7.2 为结果计数显示编写属性测试
  - **属性 13: 结果计数显示**
  - **验证: 需求 5.5**

- [ ]* 7.3 为结果排序编写属性测试
  - **属性 24: 结果按日期降序排列**
  - **验证: 需求 8.5**

- [ ]* 7.4 为结果虚拟化编写单元测试
  - **属性 37: 结果虚拟化**
  - **验证: 需求 15.3**

- [ ]* 7.5 为ARIA实时区域编写单元测试
  - **属性 35: ARIA实时区域更新**
  - **验证: 需求 14.3**

- [x] 8. 创建SearchPage主组件
  - 创建`src/pages/SearchPage.tsx`文件
  - 实现页面状态管理（useState hooks）
  - 实现`executeSearch`函数（调用searchService）
  - 实现`handleSearchChange`函数（带防抖）
  - 实现`clearAllFilters`函数
  - 实现过滤器变化处理函数
  - 实现错误处理和Toast通知
  - 组合SearchBar、AdvancedFilters和SearchResults组件
  - 实现"清除所有过滤器"按钮
  - 添加页面级ARIA标签
  - _需求: 1.1, 1.2, 1.3, 2.1, 2.2, 3.1, 3.2, 4.1, 4.2, 4.3, 5.1, 10.1, 10.2, 10.3, 10.4, 10.5_

- [ ]* 8.1 为全文搜索匹配编写属性测试
  - **属性 1: 全文搜索匹配**
  - **验证: 需求 1.1, 1.2**

- [ ]* 8.2 为空查询编写单元测试
  - **属性 2: 空查询返回所有条目**
  - **验证: 需求 1.3**

- [ ]* 8.3 为标签过滤器移除编写属性测试
  - **属性 6: 标签过滤器移除更新结果**
  - **验证: 需求 2.2, 2.5**

- [ ]* 8.4 为清除所有过滤器编写属性测试
  - **属性 25: 清除所有过滤器重置状态**
  - **验证: 需求 10.2, 10.3, 10.5**

- [ ]* 8.5 为清除按钮状态编写属性测试
  - **属性 26: 清除按钮状态管理**
  - **验证: 需求 10.4**

- [x] 9. 检查点 - 确保核心搜索功能正常工作
  - 确保所有测试通过，如有问题请询问用户。

- [x] 10. 添加路由和导航集成
  - 在路由配置中添加`/search`路由（指向SearchPage）
  - 在Sidebar组件中添加搜索图标和链接
  - 实现全局键盘快捷键（Cmd/Ctrl+K）
  - 实现自动聚焦搜索输入（页面加载时）
  - 实现未认证用户重定向到登录页
  - _需求: 11.1, 11.2, 16.4_

- [ ]* 10.1 为键盘快捷键编写单元测试
  - **属性 27: 键盘快捷键导航**
  - **验证: 需求 11.1, 11.2**

- [ ]* 10.2 为未认证重定向编写单元测试
  - **属性 39: 未认证用户重定向**
  - **验证: 需求 16.4**

- [x] 11. 实现键盘导航和可访问性
  - 在SearchResults中实现箭头键导航
  - 实现Enter键打开选定条目
  - 确保所有交互元素可通过Tab键访问
  - 验证所有ARIA标签正确设置
  - 实现焦点管理（模态打开/关闭时）
  - 测试屏幕阅读器兼容性
  - _需求: 11.4, 11.5, 14.1, 14.2, 14.4, 14.6_

- [ ]* 11.1 为箭头键导航编写单元测试
  - **属性 29: 箭头键结果导航**
  - **验证: 需求 11.4, 11.5**

- [ ]* 11.2 为键盘可访问性编写单元测试
  - **属性 34: 键盘可访问性**
  - **验证: 需求 14.2**

- [ ]* 11.3 为ARIA标签编写单元测试
  - **属性 33: ARIA标签完整性**
  - **验证: 需求 14.1, 14.4, 14.6**

- [x] 12. 实现响应式设计和主题支持
  - 添加移动端媒体查询（<768px）
  - 实现移动端高级过滤器模态/抽屉
  - 确保所有触摸目标至少44x44px
  - 实现深色/浅色主题样式
  - 确保搜索高亮在两种主题下都清晰可见
  - 验证颜色对比度符合WCAG AA标准
  - 使用CSS变量或主题上下文
  - _需求: 12.1, 12.2, 12.3, 12.4, 13.1, 13.2, 13.3, 13.4, 13.5, 14.5_

- [ ]* 12.1 为响应式布局编写单元测试
  - **属性 30: 响应式布局适配**
  - **验证: 需求 12.1, 12.2, 12.3**

- [ ]* 12.2 为触摸目标尺寸编写单元测试
  - **属性 31: 触摸目标尺寸**
  - **验证: 需求 12.4**

- [ ]* 12.3 为主题一致性编写属性测试
  - **属性 32: 主题一致性**
  - **验证: 需求 13.1, 13.2, 13.3, 13.4, 13.5**

- [ ]* 12.4 为颜色对比度编写单元测试
  - **属性 36: 颜色对比度**
  - **验证: 需求 14.5**

- [x] 13. 实现性能优化
  - 实现搜索结果缓存（使用React Query或自定义缓存）
  - 验证防抖正确工作（300ms）
  - 优化Supabase查询（添加必要的索引建议）
  - 实现虚拟化列表（如果尚未在步骤7中完成）
  - 添加性能监控（可选：使用React DevTools Profiler）
  - _需求: 15.1, 15.2, 15.3, 15.4, 15.5_

- [ ]* 13.1 为搜索结果缓存编写属性测试
  - **属性 38: 搜索结果缓存**
  - **验证: 需求 15.4**

- [x] 14. 实现数据库优化（可选）
  - 检查`diary_entries`表是否有全文搜索索引
  - 如果没有，创建SQL迁移添加`fts`列和GIN索引
  - 更新searchService以使用`textSearch`方法（如果Supabase支持）
  - 如果不支持，保持客户端过滤作为备选方案
  - 验证RLS策略正确配置
  - _需求: 1.1, 16.3_

- [x] 15. 实现隐私和安全功能
  - 确保搜索查询不出现在URL中
  - 验证localStorage键包含用户ID
  - 验证所有Supabase查询包含用户ID过滤
  - 测试跨用户数据隔离
  - 实现错误处理（网络错误、认证错误、验证错误）
  - _需求: 16.1, 16.2, 16.4, 16.5_

- [ ]* 15.1 为URL隐私保护编写单元测试
  - **属性 40: URL隐私保护**
  - **验证: 需求 16.5**

- [x] 16. 最终检查点 - 集成测试和用户验收
  - 确保所有测试通过，如有问题请询问用户。

## 注意事项

- 标记为`*`的任务是可选的，可以跳过以加快MVP开发
- 每个任务都引用特定需求以确保可追溯性
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边缘情况
- 使用fast-check库进行属性测试，每个测试至少运行100次迭代
- 每个属性测试必须用注释标记：`// Feature: diary-search-feature, Property {number}: {property_text}`
