# 实施计划：纸质风格日记本

## 概述

本实施计划将纸质日记本功能分解为增量的、可测试的步骤。该方法遵循自下而上的策略：首先是数据库架构和迁移，然后是数据服务、状态管理、核心 UI 组件、动画，最后是集成。每个主要组件都包括基于属性的测试，以验证设计文档中的正确性属性。

## 任务

- [ ] 1. 数据库架构和迁移设置
  - 创建包含所有必需字段和约束的 notebooks 表
  - 向 diary_entries 表添加 notebook_id、paper_style 和 bookmarked 列
  - 创建性能索引（user_id、notebook_id、全文搜索）
  - 创建 updated_at 时间戳的触发器
  - 编写迁移脚本以创建默认日记本并分配现有条目
  - _需求: 1.1, 1.2, 1.3, 2.1, 2.2, 2.5, 12.1, 12.2_

- [ ] 1.1 为迁移数据保留编写属性测试
  - **属性 26：迁移数据保留**
  - **验证：需求 12.4, 12.5**

- [ ] 1.2 为引用完整性编写属性测试
  - **属性 9：引用完整性**
  - **验证：需求 2.5**

- [ ] 2. 核心 TypeScript 类型和接口
  - 定义 Notebook、DiaryEntry、Page、PaginationState 接口
  - 定义 PaperStyle 类型和字体相关类型
  - 定义服务接口（NotebookService、EntryService、MigrationService）
  - 定义 store 接口（NotebookStore、EntryStore、UIStore）
  - 定义动画接口（PageFlipConfig、AnimationController）
  - _需求: 全部（基础类型）_

- [ ] 3. Supabase 服务层
  - [ ] 3.1 实现 NotebookService
    - 实现 getNotebooks、getNotebook、createNotebook、updateNotebook、deleteNotebook、archiveNotebook
    - 为数据库操作添加错误处理
    - _需求: 1.1, 1.2, 1.3, 1.4, 1.6, 1.7_

  - [ ] 3.2 为日记本创建验证编写属性测试
    - **属性 1：日记本创建验证**
    - **验证：需求 1.2**

  - [ ] 3.3 为默认设置分配编写属性测试
    - **属性 2：默认设置分配**
    - **验证：需求 1.3**

  - [ ] 3.4 为日记本字段可变性编写属性测试
    - **属性 3：日记本字段可变性**
    - **验证：需求 1.4**

  - [ ] 3.5 为级联删除编写属性测试
    - **属性 4：级联删除**
    - **验证：需求 1.6, 2.4**

  - [ ] 3.6 为归档保留编写属性测试
    - **属性 5：归档保留**
    - **验证：需求 1.7**

  - [ ] 3.7 实现 EntryService
    - 实现 getEntriesForNotebook、getEntry、createEntry、updateEntry、deleteEntry
    - 实现带全文搜索的 searchEntries
    - 为数据库操作添加错误处理
    - _需求: 2.1, 2.3, 8.1, 8.2, 8.3_

  - [ ] 3.8 为条目-日记本关联编写属性测试
    - **属性 6：条目-日记本关联**
    - **验证：需求 2.1**

  - [ ] 3.9 为日记本过滤编写属性测试
    - **属性 8：日记本过滤**
    - **验证：需求 2.3**

  - [ ] 3.10 为搜索范围覆盖编写属性测试
    - **属性 18：搜索范围覆盖**
    - **验证：需求 8.1**

  - [ ] 3.11 为上下文搜索范围编写属性测试
    - **属性 19：上下文搜索范围**
    - **验证：需求 8.2, 8.3**

  - [ ] 3.12 为搜索结果完整性编写属性测试
    - **属性 20：搜索结果完整性**
    - **验证：需求 8.4**

  - [ ] 3.13 实现 MigrationService
    - 实现 createDefaultNotebook、migrateExistingEntries、checkMigrationStatus
    - 为原子迁移添加事务支持
    - _需求: 12.1, 12.2, 12.3, 12.4, 12.5_

  - [ ] 3.14 为迁移分配编写属性测试
    - **属性 7：迁移分配**
    - **验证：需求 2.2, 12.2**

  - [ ] 3.15 为迁移条目默认值编写属性测试
    - **属性 27：迁移条目默认值**
    - **验证：需求 12.3**

- [ ] 4. 检查点 - 确保服务层测试通过
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 5. Zustand 状态管理 stores
  - [ ] 5.1 实现 NotebookStore
    - 创建包含 notebooks 数组、activeNotebook、loading、error 状态的 store
    - 实现 fetchNotebooks、createNotebook、updateNotebook、deleteNotebook、archiveNotebook 操作
    - 添加乐观更新以获得更好的用户体验
    - _需求: 1.1, 1.2, 1.3, 1.4, 1.6, 1.7_

  - [ ] 5.2 为设置持久化往返编写属性测试
    - **属性 12：设置持久化往返**
    - **验证：需求 3.5, 4.5**

  - [ ] 5.3 实现 EntryStore
    - 创建包含 entries 数组、loading、error 状态的 store
    - 实现 fetchEntriesForNotebook、createEntry、updateEntry、deleteEntry、toggleBookmark、searchEntries 操作
    - 为书签添加乐观更新
    - _需求: 2.1, 2.3, 7.1, 7.5, 8.1, 8.2, 8.3_

  - [ ] 5.4 为书签持久化编写属性测试
    - **属性 15：书签持久化**
    - **验证：需求 7.1, 7.5**

  - [ ] 5.5 实现 UIStore
    - 创建包含 viewMode、paginationState、无障碍偏好的 store
    - 实现导航操作（navigateToPage、navigateNext、navigatePrevious、jumpToDate）
    - 实现 UI 切换操作（目录、书签、环境音效）
    - 为用户偏好添加 localStorage 持久化
    - _需求: 7.2, 9.1, 9.2, 10.2, 10.3, 11.1, 11.4_

  - [ ] 5.6 为环境音效偏好持久化编写属性测试
    - **属性 25：环境音效偏好持久化**
    - **验证：需求 11.4**

- [ ] 6. 分页和导航逻辑
  - [ ] 6.1 实现 PaginationService
    - 实现 calculatePages 函数（条目内容 → 基于视口的页面）
    - 实现 getVisiblePages 函数（当前页面 → 可见 + 相邻页面）
    - 实现 preloadAdjacentPages 函数
    - 添加记忆化以提高性能
    - _需求: 5.5, 9.1, 9.2_

  - [ ] 6.2 为分页一致性编写属性测试
    - **属性 14：分页一致性**
    - **验证：需求 5.5**

  - [ ] 6.3 为页面加载策略编写属性测试
    - **属性 21：页面加载策略**
    - **验证：需求 9.1, 9.2**

  - [ ] 6.4 实现日期导航逻辑
    - 实现 jumpToDate 函数（日期 → 页码）
    - 实现目录生成
    - _需求: 7.2, 7.3_

  - [ ] 6.5 为日期导航编写属性测试
    - **属性 16：日期导航**
    - **验证：需求 7.2**

  - [ ] 6.6 为目录完整性编写属性测试
    - **属性 17：目录完整性**
    - **验证：需求 7.3**

- [ ] 7. 检查点 - 确保分页和导航测试通过
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 8. 纸张背景组件
  - [ ] 8.1 创建 PaperBackground 组件
    - 为 blank、lined、grid、dotted、vintage 样式实现 SVG 图案
    - 添加纸张纹理叠加
    - 使其响应容器大小
    - _需求: 3.1, 3.4_

  - [ ] 8.2 为纸张样式渲染编写单元测试
    - 测试每种纸张样式渲染正确的 SVG 图案
    - 测试纹理叠加已应用
    - _需求: 3.1_

  - [ ] 8.3 实现纸张样式继承逻辑
    - 创建 hook 以解析有效的纸张样式（条目覆盖或日记本默认）
    - _需求: 3.2, 3.3_

  - [ ] 8.4 为纸张样式继承编写属性测试
    - **属性 10：纸张样式继承**
    - **验证：需求 3.2**

  - [ ] 8.5 为纸张样式覆盖编写属性测试
    - **属性 11：纸张样式覆盖**
    - **验证：需求 3.3**

- [ ] 9. 字体自定义组件
  - [ ] 9.1 创建 FontProvider 组件
    - 实现字体系列加载（system、handwriting、serif、sans-serif）
    - 为字体设置创建上下文
    - 将字体设置应用于条目内容
    - _需求: 4.1, 4.2_

  - [ ] 9.2 为字体设置继承编写属性测试
    - **属性 13：字体设置继承**
    - **验证：需求 4.2**

  - [ ] 9.3 为字体大小和行高验证编写单元测试
    - 测试边界值（大小 12px-24px，行高 1.2-2.0）
    - 测试范围外的值被拒绝
    - _需求: 4.3, 4.4_

- [ ] 10. 页面显示组件
  - [ ] 10.1 创建 Page 组件
    - 使用纸张背景渲染单页
    - 使用适当的排版显示条目内容
    - 添加页码
    - 添加阴影和景深效果
    - _需求: 5.3, 5.4_

  - [ ] 10.2 创建 PageSpread 组件（桌面）
    - 并排渲染两页
    - 在中心添加书脊
    - 使其响应视口宽度
    - _需求: 5.1_

  - [ ] 10.3 创建 SinglePage 组件（移动）
    - 渲染单页视图
    - 使其响应移动视口
    - _需求: 5.2_

  - [ ] 10.4 为响应式布局编写单元测试
    - 测试桌面视口显示 PageSpread
    - 测试移动视口显示 SinglePage
    - _需求: 5.1, 5.2_

- [ ] 11. 动画系统
  - [ ] 11.1 使用 Framer Motion 实现 AnimationController
    - 实现带真实翻页动画的 flipPage 函数
    - 实现悬停效果的 applyCurlEffect
    - 实现减少动画模式的 transitionFade
    - 添加 60fps 性能监控
    - _需求: 6.1, 6.2, 6.7, 6.8, 10.3_

  - [ ] 11.2 为动画配置编写单元测试
    - 测试动画遵守 reduceMotion 偏好
    - 测试动画持续时间和缓动
    - _需求: 10.3_

  - [ ] 11.3 实现手势处理器
    - 为触摸设备添加左/右滑动处理器
    - 添加键盘箭头键处理器
    - 与导航操作集成
    - _需求: 6.3, 6.4, 6.5, 6.6_

  - [ ] 11.4 为手势和键盘导航编写单元测试
    - 测试滑动手势触发导航
    - 测试箭头键触发导航
    - _需求: 6.3, 6.4, 6.5, 6.6_

- [ ] 12. 检查点 - 确保核心 UI 组件正确渲染
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 13. 日记本管理 UI
  - [ ] 13.1 创建 NotebookCard 组件
    - 显示日记本名称、封面、描述
    - 添加编辑和删除按钮
    - 添加归档按钮
    - _需求: 1.4, 1.5, 1.6, 1.7_

  - [ ] 13.2 创建 NotebookListView 组件
    - 以列表或网格布局显示日记本
    - 添加创建日记本按钮
    - 添加搜索栏
    - 与 NotebookStore 集成
    - _需求: 1.8, 8.2_

  - [ ] 13.3 创建 NotebookForm 组件
    - 用于创建/编辑日记本的表单
    - 名称、封面、描述、纸张样式、字体设置的输入字段
    - 必填字段和范围的验证
    - _需求: 1.2, 1.3, 1.4_

  - [ ] 13.4 为日记本表单验证编写单元测试
    - 测试名称是必需的
    - 测试字体大小和行高验证
    - _需求: 1.2, 4.3, 4.4_

- [ ] 14. 导航控件 UI
  - [ ] 14.1 创建 NavigationControls 组件
    - 上一页/下一页按钮
    - 页面指示器（当前/总计）
    - 跳转到日期按钮
    - 目录按钮
    - 书签按钮
    - _需求: 6.1, 6.2, 7.2, 7.3, 7.4_

  - [ ] 14.2 创建 TableOfContents 组件
    - 显示所有条目的列表，包括日期和标题
    - 使条目可点击以导航
    - 添加虚拟滚动以提高性能
    - _需求: 7.3, 7.4_

  - [ ] 14.3 创建 BookmarkPanel 组件
    - 显示已添加书签的条目
    - 使条目可点击以导航
    - _需求: 7.1, 7.5_

- [ ] 15. 搜索 UI
  - [ ] 15.1 创建 SearchBar 组件
    - 带防抖搜索的输入字段（300ms）
    - 显示带有日期、标题、片段的搜索结果
    - 使结果可点击以导航
    - 在搜索期间显示加载状态
    - _需求: 8.1, 8.2, 8.3, 8.4, 8.5_

  - [ ] 15.2 为搜索防抖编写单元测试
    - 测试搜索被防抖 300ms
    - 测试快速输入不会触发多次搜索
    - _需求: 8.1_

- [ ] 16. 无障碍功能
  - [ ] 16.1 为所有交互元素添加 ARIA 标签和角色
    - 为按钮、输入、导航控件添加标签
    - 为自定义组件添加角色
    - 为复杂交互添加描述
    - _需求: 10.1_

  - [ ] 16.2 为无障碍属性存在编写属性测试
    - **属性 23：无障碍属性存在**
    - **验证：需求 10.1**

  - [ ] 16.3 实现键盘导航
    - 为所有导航操作添加键盘快捷键
    - 添加可见的焦点指示器
    - 添加键盘快捷键帮助面板
    - _需求: 10.4, 10.5_

  - [ ] 16.4 为键盘导航完整性编写属性测试
    - **属性 24：键盘导航完整性**
    - **验证：需求 10.5**

  - [ ] 16.5 实现无障碍偏好
    - 添加高对比度模式切换
    - 添加减少动画模式切换
    - 在 localStorage 中持久化偏好
    - _需求: 10.2, 10.3_

  - [ ] 16.6 为无障碍偏好编写单元测试
    - 测试高对比度模式应用正确的样式
    - 测试减少动画模式使用淡入淡出过渡
    - _需求: 10.2, 10.3_

- [ ] 17. 视觉增强
  - [ ] 17.1 创建 BookCover 组件
    - 显示带有颜色/图片的日记本封面
    - 添加书脊设计
    - 添加真实的阴影
    - _需求: 5.4_

  - [ ] 17.2 实现环境音效系统
    - 为背景音乐/环境声音添加音频播放器
    - 提供至少 3 种声音选项
    - 添加音量控制
    - 添加启用/禁用切换
    - 持久化偏好
    - _需求: 11.1, 11.2, 11.3, 11.4, 11.5_

  - [ ] 17.3 为环境音效控件编写单元测试
    - 测试启用/禁用切换播放
    - 测试音量控制调整音频级别
    - _需求: 11.1, 11.2, 11.3_

- [ ] 18. 缓存和性能优化
  - [ ] 18.1 实现缓存管理器
    - 在内存中缓存日记本设置
    - 缓存相邻页面
    - 在 CRUD 操作时使缓存失效
    - _需求: 9.4_

  - [ ] 18.2 为日记本设置缓存编写属性测试
    - **属性 22：日记本设置缓存**
    - **验证：需求 9.4**

  - [ ] 18.3 优化图像和资源
    - 添加响应式图像加载
    - 压缩纸张纹理
    - 懒加载字体
    - _需求: 9.5_

- [ ] 19. 集成和连接
  - [ ] 19.1 创建 NotebookReaderView 组件
    - 集成所有子组件（页面、导航、目录、书签）
    - 连接到 stores
    - 处理加载和错误状态
    - _需求: 全部_

  - [ ] 19.2 创建 App 路由
    - 日记本列表视图的路由
    - 日记本阅读视图的路由
    - 处理视图之间的导航
    - _需求: 全部_

  - [ ] 19.3 添加错误边界
    - 优雅地捕获和显示错误
    - 添加重试机制
    - 记录错误以进行调试
    - _需求: 错误处理_

  - [ ] 19.4 编写集成测试
    - 测试完整的用户流程（创建日记本 → 添加条目 → 导航 → 搜索）
    - 测试错误场景
    - _需求: 全部_

- [ ] 20. 迁移执行
  - [ ] 20.1 创建迁移 UI
    - 显示迁移进度
    - 显示成功/错误消息
    - 在升级后首次登录时处理迁移
    - _需求: 12.1, 12.2, 12.3, 12.4, 12.5_

  - [ ] 20.2 使用示例数据测试迁移
    - 创建包含现有条目的测试数据集
    - 运行迁移
    - 验证所有条目已分配给默认日记本
    - 验证数据保留
    - _需求: 12.1, 12.2, 12.3, 12.4, 12.5_

- [ ] 21. 最终检查点 - 确保所有测试通过且功能完整
  - 运行完整的测试套件（单元 + 属性测试）
  - 在桌面和移动视口上测试
  - 使用屏幕阅读器测试无障碍性
  - 验证性能（动画、加载时间）
  - 确保所有测试通过，如有问题请询问用户。

## 注意事项

- 所有任务都是全面实施所必需的
- 每个任务都引用特定需求以便追溯
- 检查点确保整个实施过程中的增量验证
- 属性测试验证设计文档中的通用正确性属性
- 单元测试验证特定示例、边缘情况和错误条件
- 集成测试验证端到端用户流程
- 实施遵循自下而上的方法：数据层 → 服务 → 状态 → UI → 集成
- 所有 UI 组件必须支持深色/浅色主题和双语文本（中文/英文）
- 所有交互组件必须支持键盘访问和屏幕阅读器友好
- 所有属性测试应使用 fast-check 库运行最少 100 次迭代
