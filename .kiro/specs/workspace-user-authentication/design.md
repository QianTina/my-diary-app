# 设计文档：用户认证系统

## 概述

本设计文档描述了使用 Supabase Auth 为个人工作台平台实现用户认证系统。该系统将把现有的单用户日记应用转变为具有适当数据隔离的安全多用户平台。

### 关键设计决策

1. **Supabase Auth**：使用 Supabase 的内置认证服务而不是构建自定义认证，以最小的实现工作量提供企业级安全性
2. **行级安全策略（RLS）**：利用 PostgreSQL RLS 策略在数据库级别强制执行数据隔离，即使应用程序逻辑失败也能确保安全
3. **Zustand 状态管理**：继续使用 Zustand 进行认证状态管理，以保持与现有存储模式的一致性
4. **Auth UI 组件**：使用 @supabase/auth-ui-react 进行登录/注册表单，以减少开发时间并确保可访问性
5. **受保护路由模式**：实现 ProtectedRoute 包装器组件以集中认证检查

### 架构目标

- **安全优先**：所有数据访问由 RLS 策略控制
- **无缝用户体验**：自动会话持久化和刷新
- **最小干扰**：与现有代码库集成而无需大规模重构
- **可扩展性**：支持未来的多租户功能（日历、待办事项等）

## 架构

### 系统组件

```
┌─────────────────────────────────────────────────────────────┐
│                      浏览器应用程序                           │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  登录页面    │  │  受保护      │  │  用户菜单    │      │
│  │              │  │  路由        │  │              │      │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘      │
│         │                  │                  │              │
│         └──────────────────┼──────────────────┘              │
│                            │                                 │
│                    ┌───────▼────────┐                        │
│                    │  AuthStore     │                        │
│                    │  (Zustand)     │                        │
│                    └───────┬────────┘                        │
│                            │                                 │
├────────────────────────────┼─────────────────────────────────┤
│                            │                                 │
│                    ┌───────▼────────┐                        │
│                    │ Supabase       │                        │
│                    │ 客户端         │                        │
│                    └───────┬────────┘                        │
│                            │                                 │
└────────────────────────────┼─────────────────────────────────┘
                             │
                             │ HTTPS
                             │
┌────────────────────────────▼─────────────────────────────────┐
│                      Supabase 后端                            │
├───────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 认证服务     │  │  PostgreSQL  │  │  存储        │      │
│  │              │  │  + RLS       │  │              │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                                                               │
└───────────────────────────────────────────────────────────────┘
```

### 认证流程

```
用户操作          应用程序              Supabase Auth         数据库
    │                     │                         │                   │
    │  输入凭证           │                         │                   │
    ├────────────────────>│                         │                   │
    │                     │  signInWithPassword()   │                   │
    │                     ├────────────────────────>│                   │
    │                     │                         │  验证密码         │
    │                     │                         ├──────────────────>│
    │                     │                         │<──────────────────┤
    │                     │  会话 + JWT             │                   │
    │                     │<────────────────────────┤                   │
    │                     │  更新 AuthStore         │                   │
    │                     │  设置用户状态           │                   │
    │  重定向到主页       │                         │                   │
    │<────────────────────┤                         │                   │
    │                     │                         │                   │
    │  访问日记数据       │                         │                   │
    ├────────────────────>│  带 JWT 的查询          │                   │
    │                     ├────────────────────────────────────────────>│
    │                     │                         │  RLS 检查 JWT     │
    │                     │                         │  返回用户数据     │
    │                     │<────────────────────────────────────────────┤
    │  显示数据           │                         │                   │
    │<────────────────────┤                         │                   │
```

### 会话管理

Supabase Auth 自动处理：
- **JWT 令牌生成**：创建带有用户声明的签名令牌
- **令牌刷新**：在过期前自动刷新令牌
- **会话持久化**：在 localStorage 中存储会话
- **状态同步**：跨标签页广播认证状态变化

应用程序通过 `supabase.auth.onAuthStateChange()` 订阅认证状态变化以保持 UI 同步。

## 组件和接口

### 1. 认证存储 (authStore.ts)

**目的**：认证的集中式状态管理

**接口**：
```typescript
interface AuthState {
  user: User | null;
  isLoading: boolean;
  isAuthenticated: boolean;
  
  initialize: () => Promise<void>;
  signOut: () => Promise<void>;
}
```

**职责**：
- 在应用加载时初始化认证状态
- 订阅 Supabase 认证状态变化
- 向组件提供用户信息
- 处理登出操作

**实现说明**：
- 使用 Zustand 进行状态管理
- 在初始化时调用 `supabase.auth.getUser()`
- 设置 `onAuthStateChange` 监听器以实现实时更新
- 根据用户存在情况更新 `isAuthenticated` 标志

### 2. 登录页面 (LoginPage.tsx)

**目的**：用户认证界面

**接口**：
```typescript
export default function LoginPage(): JSX.Element
```

**职责**：
- 使用 Supabase Auth UI 渲染登录/注册表单
- 将已认证用户重定向到主页
- 应用主题样式（深色/浅色模式）
- 显示认证错误

**实现说明**：
- 使用 `@supabase/auth-ui-react` 进行表单渲染
- 检查 `isAuthenticated` 状态，如果为 true 则重定向
- 应用自定义样式以匹配应用程序主题
- 支持双语标签（英文/中文）

### 3. 受保护路由 (ProtectedRoute.tsx)

**目的**：路由级别的认证守卫

**接口**：
```typescript
export default function ProtectedRoute(): JSX.Element
```

**职责**：
- 在渲染路由之前检查认证状态
- 在认证初始化期间显示加载状态
- 将未认证用户重定向到登录页面
- 为已认证用户渲染子路由

**实现说明**：
- 使用 React Router 的 `<Outlet />` 进行嵌套路由
- 检查 `isLoading` 以防止过早重定向
- 使用 `<Navigate />` 进行声明式重定向
- 在 App.tsx 中包装所有受保护的路由

### 4. 用户菜单 (UserMenu.tsx)

**目的**：在侧边栏中显示用户资料和操作

**接口**：
```typescript
export default function UserMenu(): JSX.Element
```

**职责**：
- 显示用户头像（首字母或图片）
- 显示用户名称和电子邮件
- 提供资料导航链接
- 提供登出按钮

**实现说明**：
- 从 AuthStore 读取用户数据
- 从电子邮件首字符生成头像
- 应用主题感知样式
- 登出时从 AuthStore 调用 `signOut()`

### 5. 资料页面 (ProfilePage.tsx)

**目的**：用户资料管理界面

**接口**：
```typescript
export default function ProfilePage(): JSX.Element
```

**职责**：
- 显示当前用户信息
- 允许编辑名称和头像 URL
- 将资料更新保存到 Supabase
- 显示成功/错误消息

**实现说明**：
- 使用 `supabase.auth.updateUser()` 进行更新
- 更新 `user_metadata` 字段
- 在提交前验证输入
- 在更新期间显示加载状态

### 6. 更新的日记存储 (diaryStore.ts)

**目的**：带有用户关联的日记数据管理

**所需更改**：
- 在日记创建时添加 `user_id`
- 在操作前从 Supabase Auth 获取用户 ID
- 优雅地处理认证错误

**实现**：
```typescript
createDiary: async (diaryData) => {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) throw new Error('Not authenticated');
  
  const newDiary = {
    ...diaryData,
    user_id: user.id,
  };
  
  // 继续现有逻辑
}
```

## 数据模型

### 用户类型

```typescript
interface User {
  id: string;                    // 来自 Supabase Auth 的 UUID
  email: string;                 // 用户的电子邮件地址
  user_metadata?: {              // 可选元数据
    name?: string;               // 显示名称
    avatar_url?: string;         // 头像图片 URL
  };
  created_at: string;            // 账户创建时间戳
}
```

### 更新的日记类型

```typescript
interface Diary {
  id: string;
  user_id: string;               // 新增：指向 auth.users 的外键
  title: string;
  content: string;
  mood: Mood | null;
  weather: Weather | null;
  location: string;
  tags: string[];
  images: string[];
  isEncrypted: boolean;
  createdAt: string;
  updatedAt: string;
}
```

### 数据库架构更改

**向 diaries 表添加 user_id 列**：
```sql
ALTER TABLE diaries 
ADD COLUMN user_id UUID REFERENCES auth.users(id);
```

**创建索引以提高性能**：
```sql
CREATE INDEX diaries_user_id_idx ON diaries(user_id);
```

### 行级安全策略

**启用 RLS**：
```sql
ALTER TABLE diaries ENABLE ROW LEVEL SECURITY;
```

**SELECT 策略** - 用户可以查看自己的日记：
```sql
CREATE POLICY "Users can view their own diaries"
ON diaries FOR SELECT
USING (auth.uid() = user_id);
```

**INSERT 策略** - 用户可以为自己创建日记：
```sql
CREATE POLICY "Users can insert their own diaries"
ON diaries FOR INSERT
WITH CHECK (auth.uid() = user_id);
```

**UPDATE 策略** - 用户可以更新自己的日记：
```sql
CREATE POLICY "Users can update their own diaries"
ON diaries FOR UPDATE
USING (auth.uid() = user_id);
```

**DELETE 策略** - 用户可以删除自己的日记：
```sql
CREATE POLICY "Users can delete their own diaries"
ON diaries FOR DELETE
USING (auth.uid() = user_id);
```

**RLS 工作原理**：
- `auth.uid()` 是一个从 JWT 令牌中提取用户 ID 的 PostgreSQL 函数
- JWT 令牌会自动随每个 Supabase 查询发送
- RLS 策略在返回任何数据之前在数据库级别进行评估
- 如果策略条件失败，查询不返回任何结果（就像数据不存在一样）

## 正确性属性

*属性是在系统的所有有效执行中应该保持为真的特征或行为——本质上是关于系统应该做什么的正式声明。属性充当人类可读规范和机器可验证正确性保证之间的桥梁。*


### 属性 1：有效注册创建账户

*对于任何*有效的电子邮件和密码组合（带有 @ 和域名的电子邮件，密码 ≥ 6 个字符），注册应在 Supabase Auth 中创建新用户账户，并自动登录用户并重定向到主页。

**验证：需求 1.1, 1.5**

### 属性 2：无效输入拒绝

*对于任何*无效的注册输入（格式错误的电子邮件，密码 < 6 个字符），系统应拒绝注册并显示适当的错误消息，而不创建账户。

**验证：需求 1.2, 1.3**

### 属性 3：有效登录创建会话

*对于任何*具有有效凭证的注册用户，登录应创建已认证会话并重定向到主页。

**验证：需求 2.1**

### 属性 4：无效凭证拒绝

*对于任何*使用无效凭证的登录尝试（错误的密码、不存在的电子邮件），系统应拒绝登录并显示错误消息，而不创建会话。

**验证：需求 2.2**

### 属性 5：已认证用户登录重定向

*对于任何*尝试访问登录页面的已认证用户，系统应将其重定向到主页。

**验证：需求 2.3**

### 属性 6：会话持久化

*对于任何*已认证会话，刷新浏览器应保持会话而无需重新认证。

**验证：需求 2.5**

### 属性 7：登出清除会话

*对于任何*已认证用户，点击登出应终止会话，清除浏览器中的所有会话数据，并重定向到登录页面。

**验证：需求 3.1, 3.2, 3.3**

### 属性 8：未认证路由保护

*对于任何*受保护路由，未认证用户尝试访问它应被重定向到登录页面。

**验证：需求 4.1**

### 属性 9：已认证路由访问

*对于任何*受保护路由和任何已认证用户，用户应能够访问和查看路由内容。

**验证：需求 4.2**

### 属性 10：路由配置保护

*对于所有*应用程序路由（除了 /login 和 /register），路由应需要认证才能访问。

**验证：需求 4.4**

### 属性 11：资料数据显示

*对于任何*访问资料页面的已认证用户，系统应显示其电子邮件和元数据（名称、头像）。

**验证：需求 5.1**

### 属性 12：资料更新持久化

*对于任何*已认证用户和任何有效的资料更新（名称或头像 URL），系统应将更改保存到 Supabase Auth 并显示成功消息。

**验证：需求 5.2, 5.3, 5.5**

### 属性 13：日记用户关联

*对于任何*创建日记条目的已认证用户，该条目应与该用户的 ID 关联。

**验证：需求 6.1**

### 属性 14：日记读取隔离

*对于任何*查询日记条目的已认证用户，系统应仅返回属于该用户的条目，绝不返回其他用户的条目。

**验证：需求 6.2, 6.3**

### 属性 15：日记写入隔离

*对于任何*尝试更新或删除日记条目的已认证用户，只有当条目属于该用户时操作才应成功，对于属于其他用户的条目应失败。

**验证：需求 6.4, 6.5**

### 属性 16：认证状态同步

*对于任何*认证状态变化（登录、登出、会话刷新），所有依赖于用户状态的组件都应更新以反映新状态。

**验证：需求 7.2**

### 属性 17：认证初始化顺序

*对于任何*应用程序加载，认证状态应在渲染任何受保护路由之前初始化和确定。

**验证：需求 7.4**

### 属性 18：侧边栏用户显示

*对于任何*已认证用户，侧边栏应显示用户的头像（或首字母）和名称（或电子邮件）。

**验证：需求 8.1, 8.2**

### 属性 19：用户菜单交互

*对于任何*在侧边栏中点击其资料的已认证用户，系统应显示包含资料和登出选项的菜单。

**验证：需求 8.3**

### 属性 20：错误消息显示

*对于任何*失败的操作（认证失败、网络错误、验证错误），系统应显示适当的用户友好错误消息。

**验证：需求 10.1, 10.2, 10.3**

### 属性 21：错误消息清除

*对于任何*显示的错误消息，更正导致错误的输入应清除错误消息。

**验证：需求 10.4**

### 属性 22：成功消息显示

*对于任何*成功的操作（注册、登录、资料更新），系统应显示成功消息。

**验证：需求 10.5**

## 错误处理

### 认证错误

**错误类型**：
1. **无效凭证**：错误的电子邮件/密码组合
2. **用户未找到**：电子邮件未注册
3. **电子邮件已存在**：重复注册尝试
4. **弱密码**：密码不符合要求
5. **无效电子邮件**：格式错误的电子邮件地址
6. **会话过期**：JWT 令牌过期
7. **网络错误**：连接到 Supabase 失败

**错误处理策略**：
- 在 try-catch 块中捕获所有 Supabase Auth 错误
- 将 Supabase 错误代码映射到用户友好的消息
- 在相关表单字段附近的 UI 中显示错误
- 将详细错误记录到控制台以进行调试
- 绝不向用户暴露敏感的错误详情

**错误映射示例**：
```typescript
const getErrorMessage = (error: AuthError): string => {
  switch (error.message) {
    case 'Invalid login credentials':
      return '电子邮件或密码不正确';
    case 'User already registered':
      return '此电子邮件的账户已存在';
    case 'Password should be at least 6 characters':
      return '密码必须至少 6 个字符';
    default:
      return '发生错误。请重试。';
  }
};
```

### RLS 策略错误

**错误类型**：
1. **未授权访问**：用户尝试访问其他用户的数据
2. **缺少 user_id**：创建的日记条目没有 user_id
3. **无效 JWT**：格式错误或过期的令牌

**错误处理策略**：
- RLS 策略静默过滤未授权的数据（不抛出错误）
- 应用程序不应尝试访问其他用户的数据
- 如果查询意外返回空结果，检查认证状态
- 记录 RLS 违规以进行安全监控

### 网络错误

**错误类型**：
1. **连接超时**：请求耗时过长
2. **无互联网**：用户离线
3. **服务器错误**：Supabase 服务不可用

**错误处理策略**：
- 使用 try-catch 检测网络错误
- 向用户显示"连接错误"消息
- 为失败的操作提供重试按钮
- 考虑使用 LocalStorage 回退实现离线模式

### 验证错误

**错误类型**：
1. **空字段**：必填字段未填写
2. **无效格式**：电子邮件、URL 格式不正确
3. **长度约束**：密码太短、名称太长

**错误处理策略**：
- 在 API 调用之前在客户端进行验证
- 显示特定于字段的错误消息
- 用红色边框突出显示无效字段
- 当用户更正输入时清除错误

## 测试策略

### 双重测试方法

此功能需要单元测试和基于属性的测试来确保全面覆盖：

**单元测试**关注：
- 认证流程的具体示例
- 边缘情况（空输入、特殊字符）
- 错误条件（网络故障、无效令牌）
- 组件之间的集成
- UI 交互（按钮点击、表单提交）

**基于属性的测试**关注：
- 所有输入的通用属性
- 数据隔离保证
- 会话管理正确性
- 所有路由的路由保护
- 所有状态变化的状态同步

这些方法共同提供全面覆盖：单元测试捕获特定场景中的具体错误，而属性测试验证整个输入空间的一般正确性。

### 基于属性的测试配置

**测试库**：使用 `fast-check` 进行 TypeScript 基于属性的测试

**安装**：
```bash
npm install --save-dev fast-check @types/fast-check
```

**配置**：
- 每个属性测试应至少运行 100 次迭代
- 为电子邮件、密码、用户 ID 使用适当的生成器
- 用功能名称和属性编号标记每个测试
- 在测试注释中引用设计文档属性

**标记格式**：
```typescript
// 功能: workspace-user-authentication, 属性 1: 有效注册创建账户
test('有效注册创建账户并登录用户', () => {
  fc.assert(
    fc.property(
      fc.emailAddress(),
      fc.string({ minLength: 6, maxLength: 20 }),
      async (email, password) => {
        // 测试实现
      }
    ),
    { numRuns: 100 }
  );
});
```

### 测试组织

**单元测试**：
- `authStore.test.ts`：测试认证状态管理
- `LoginPage.test.tsx`：测试登录 UI 和交互
- `ProtectedRoute.test.tsx`：测试路由保护逻辑
- `UserMenu.test.tsx`：测试用户菜单显示和操作
- `ProfilePage.test.tsx`：测试资料管理
- `diaryStore.test.ts`：测试带 user_id 的日记操作

**属性测试**：
- `auth.properties.test.ts`：属性 1-10（认证流程）
- `profile.properties.test.ts`：属性 11-12（资料管理）
- `dataIsolation.properties.test.ts`：属性 13-15（RLS 和数据隔离）
- `ui.properties.test.ts`：属性 16-22（UI 状态和反馈）

### 关键测试场景

**必须测试**：
1. 使用各种电子邮件/密码组合进行用户注册
2. 使用有效和无效凭证登录
3. 跨页面刷新的会话持久化
4. 登出清除所有会话数据
5. 未认证用户无法访问受保护路由
6. 已认证用户可以访问所有受保护路由
7. 用户只能看到自己的日记条目
8. 用户无法访问其他用户的日记条目
9. 资料更新正确持久化
10. 所有错误条件都显示错误消息

### 测试 RLS 策略

**方法**：
- 在 Supabase 中创建多个测试用户
- 为每个用户创建日记条目
- 尝试跨用户访问并验证拒绝
- 在启用 RLS 的情况下测试所有 CRUD 操作
- 验证查询仅返回用户自己的数据

**测试示例**：
```typescript
test('用户无法访问其他用户的日记条目', async () => {
  const user1 = await createTestUser('user1@test.com');
  const user2 = await createTestUser('user2@test.com');
  
  const diary1 = await createDiary(user1, { title: '用户 1 的日记' });
  
  // 切换到 user2 的会话
  await loginAs(user2);
  
  // 尝试获取所有日记
  const diaries = await getDiaries();
  
  // 不应包含 user1 的日记
  expect(diaries).not.toContainEqual(expect.objectContaining({ id: diary1.id }));
});
```

### 性能测试

**要监控的指标**：
- 登录时间：< 1 秒
- 注册时间：< 2 秒
- 路由保护检查：< 100 毫秒
- 资料更新：< 1 秒
- 带 RLS 的日记查询：< 500 毫秒

**工具**：
- 使用浏览器 DevTools 性能标签
- 在仪表板中监控 Supabase 查询性能
- 在 CI/CD 中设置性能预算

### 集成测试

**测试流程**：
1. 完整的注册 → 登录 → 创建日记 → 登出流程
2. 登录 → 更新资料 → 验证更改持久化
3. 登录 → 创建日记 → 登出 → 以不同用户登录 → 验证隔离
4. 会话过期 → 自动重定向到登录
5. 多个标签页 → 认证状态同步

### 可访问性测试

**要求**：
- 所有表单必须可通过键盘导航
- 错误消息必须由屏幕阅读器宣布
- 导航期间的焦点管理
- 所有交互元素上的 ARIA 标签

**工具**：
- 使用 `@testing-library/react` 进行可访问性检查
- 运行 `axe-core` 自动化可访问性测试
- 手动键盘导航测试
