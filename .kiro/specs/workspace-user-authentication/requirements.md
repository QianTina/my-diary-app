# 需求文档：用户认证系统

## 简介

本规范定义了个人工作台平台用户认证系统的实现需求。该系统将把现有的单用户日记应用转变为具有安全数据隔离的多用户平台，为未来扩展日历、待办事项和其他工作台功能奠定基础。

认证系统将使用 Supabase Auth 进行用户管理，并使用行级安全策略（RLS）实现数据隔离，确保每个用户只能访问自己的数据。

## 术语表

- **系统**：个人工作台 Web 应用程序
- **用户**：注册并使用工作台平台的个人
- **Supabase_Auth**：管理用户账户的 Supabase 认证服务
- **RLS**：行级安全策略 - 限制数据访问的 PostgreSQL 安全策略
- **Auth_Session**：具有有效凭证的已认证用户会话
- **Protected_Route**：需要认证才能访问的路由
- **User_Profile**：包含电子邮件和元数据的用户账户信息
- **Diary_Entry**：属于特定用户的日记记录

## 需求

### 需求 1：用户注册

**用户故事：** 作为新用户，我想使用电子邮件和密码注册账户，以便安全地存储我的个人数据。

#### 验收标准

1. 当用户提供有效的电子邮件和密码时，系统应在 Supabase_Auth 中创建新的用户账户
2. 当用户提供无效的电子邮件格式时，系统应拒绝注册并显示错误消息
3. 当用户提供少于 6 个字符的密码时，系统应拒绝注册并显示错误消息
4. 当用户尝试使用已存在的电子邮件注册时，系统应拒绝注册并显示错误消息
5. 当注册成功时，系统应自动登录用户并重定向到主页

### 需求 2：用户登录

**用户故事：** 作为注册用户，我想使用我的凭证登录，以便访问我的个人工作台。

#### 验收标准

1. 当用户提供有效凭证时，系统应创建 Auth_Session 并重定向到主页
2. 当用户提供无效凭证时，系统应拒绝登录并显示错误消息
3. 当用户已经登录时，系统应从登录页面重定向到主页
4. 当 Auth_Session 过期时，系统应将用户重定向到登录页面
5. 系统应在浏览器刷新后保持 Auth_Session

### 需求 3：用户登出

**用户故事：** 作为已登录用户，我想登出我的账户，以便在使用共享设备时保护我的数据。

#### 验收标准

1. 当用户点击登出按钮时，系统应终止 Auth_Session
2. 当登出完成时，系统应将用户重定向到登录页面
3. 当用户登出时，系统应清除浏览器中的所有会话数据

### 需求 4：路由保护

**用户故事：** 作为系统管理员，我想确保只有已认证的用户才能访问应用程序，以便未授权用户无法查看私人数据。

#### 验收标准

1. 当未认证用户尝试访问 Protected_Route 时，系统应重定向到登录页面
2. 当已认证用户访问 Protected_Route 时，系统应渲染请求的页面
3. 当认证状态正在加载时，系统应显示加载指示器
4. 系统应保护除登录和注册页面之外的所有路由

### 需求 5：用户资料管理

**用户故事：** 作为已登录用户，我想查看和更新我的个人资料信息，以便管理我的账户详情。

#### 验收标准

1. 当用户访问个人资料页面时，系统应显示用户的电子邮件和元数据
2. 当用户更新其个人资料名称时，系统应将更改保存到 Supabase_Auth
3. 当用户更新其头像 URL 时，系统应保存更改并显示新头像
4. 系统应将用户的电子邮件显示为只读
5. 当个人资料更新成功时，系统应显示成功消息

### 需求 6：使用行级安全策略的数据隔离

**用户故事：** 作为用户，我想让我的日记条目保持私密，以便其他用户无法访问我的个人数据。

#### 验收标准

1. 当用户创建 Diary_Entry 时，系统应将其与用户的 ID 关联
2. 当用户查询 Diary_Entry 记录时，系统应仅返回属于该用户的条目
3. 当用户尝试访问其他用户的 Diary_Entry 时，RLS 应阻止访问
4. 当用户更新 Diary_Entry 时，RLS 应仅允许更新其自己的条目
5. 当用户删除 Diary_Entry 时，RLS 应仅允许删除其自己的条目

### 需求 7：认证状态管理

**用户故事：** 作为开发人员，我想要集中式的认证状态管理，以便应用程序能够一致地响应认证变化。

#### 验收标准

1. 系统应在全局存储中维护当前用户状态
2. 当认证状态改变时，系统应更新所有依赖于用户状态的组件
3. 系统应订阅 Supabase_Auth 状态变化
4. 当应用程序加载时，系统应在渲染受保护路由之前初始化认证状态
5. 系统应向所有组件公开认证状态

### 需求 8：用户界面集成

**用户故事：** 作为已登录用户，我想在侧边栏中看到我的个人资料信息，以便知道我正在使用哪个账户。

#### 验收标准

1. 当用户已登录时，系统应在侧边栏中显示用户的头像或首字母
2. 当用户已登录时，系统应在侧边栏中显示用户的名称或电子邮件
3. 当用户点击侧边栏中的个人资料时，系统应显示包含个人资料和登出选项的菜单
4. 系统应在用户菜单中显示登出按钮
5. 系统应在用户菜单中显示个人资料链接

### 需求 9：数据库架构迁移

**用户故事：** 作为系统管理员，我想迁移现有的日记数据以支持多用户访问，以便数据库架构支持用户隔离。

#### 验收标准

1. 系统应向 diaries 表添加 user_id 列
2. 系统应在 diaries.user_id 和 auth.users.id 之间创建外键关系
3. 系统应在 diaries 表上启用 RLS
4. 系统应为 SELECT、INSERT、UPDATE 和 DELETE 操作创建 RLS 策略
5. 系统应在 user_id 列上创建索引以提高查询性能

### 需求 10：错误处理和用户反馈

**用户故事：** 作为用户，我想在认证失败时看到清晰的错误消息，以便了解出了什么问题以及如何修复。

#### 验收标准

1. 当认证失败时，系统应显示用户友好的错误消息
2. 当发生网络错误时，系统应显示网络错误消息
3. 当发生验证错误时，系统应显示特定于字段的错误消息
4. 当用户更正输入时，系统应清除错误消息
5. 系统应为成功的操作显示成功消息
