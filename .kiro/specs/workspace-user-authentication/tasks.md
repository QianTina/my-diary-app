# 实施计划：用户认证系统

## 概述

本实施计划将用户认证系统分解为增量的、可测试的步骤。每个任务都建立在之前的工作基础上，并在整个过程中集成基于属性的测试以尽早发现错误。该计划遵循自下而上的方法：首先是核心基础设施，然后是认证流程，接着是 UI 集成，最后是数据隔离。

## 任务

- [x] 1. 设置认证基础设施
  - 安装所需依赖 (@supabase/auth-ui-react, @supabase/auth-ui-shared, fast-check)
  - 在 src/types/auth.ts 中创建 User 和 AuthState 的类型定义
  - 设置基于属性测试的测试框架配置
  - _需求: 7.1, 7.5_

- [x] 2. 实现认证状态管理
  - [x] 2.1 使用 Zustand 创建 AuthStore
    - 实现 user、isLoading 和 isAuthenticated 状态
    - 实现 initialize() 函数从 Supabase 获取当前用户
    - 实现 signOut() 函数
    - 设置 onAuthStateChange 监听器以实现实时更新
    - _需求: 7.1, 7.2, 7.4_
  
  - [ ]* 2.2 编写认证状态初始化的属性测试
    - **属性 17: 认证初始化顺序**
    - **验证: 需求 7.4**
  
  - [ ]* 2.3 编写认证状态同步的属性测试
    - **属性 16: 认证状态同步**
    - **验证: 需求 7.2**

- [x] 3. 实现登录页面
  - [x] 3.1 创建 LoginPage 组件
    - 使用 @supabase/auth-ui-react Auth 组件
    - 基于 themeStore 配置主题（深色/浅色）
    - 添加双语标签（英文/中文）
    - 为已认证用户实现重定向逻辑
    - _需求: 2.1, 2.2, 2.3_
  
  - [ ]* 3.2 编写有效登录的属性测试
    - **属性 3: 有效登录创建会话**
    - **验证: 需求 2.1**
  
  - [ ]* 3.3 编写无效凭证拒绝的属性测试
    - **属性 4: 无效凭证拒绝**
    - **验证: 需求 2.2**
  
  - [ ]* 3.4 编写已认证用户重定向的属性测试
    - **属性 5: 已认证用户登录重定向**
    - **验证: 需求 2.3**
  
  - [ ]* 3.5 编写 LoginPage UI 的单元测试
    - 测试表单渲染
    - 测试主题应用
    - 测试错误消息显示
    - _需求: 2.1, 2.2, 10.1_

- [x] 4. 实现注册流程
  - [x] 4.1 配置注册的 Auth UI
    - 在 Auth 组件中启用注册模式
    - 添加电子邮件和密码验证
    - 实现注册后重定向
    - _需求: 1.1, 1.2, 1.3, 1.5_
  
  - [ ]* 4.2 编写有效注册的属性测试
    - **属性 1: 有效注册创建账户**
    - **验证: 需求 1.1, 1.5**
  
  - [ ]* 4.3 编写无效输入拒绝的属性测试
    - **属性 2: 无效输入拒绝**
    - **验证: 需求 1.2, 1.3**
  
  - [ ]* 4.4 编写重复电子邮件处理的单元测试
    - 测试使用现有电子邮件注册
    - 验证错误消息显示
    - _需求: 1.4, 10.1_

- [x] 5. 检查点 - 确保认证流程正常工作
  - 手动测试注册、登录和登出
  - 验证错误消息正确显示
  - 确保所有测试通过，如有问题请询问用户

- [x] 6. 实现路由保护
  - [x] 6.1 创建 ProtectedRoute 组件
    - 从 AuthStore 检查 isAuthenticated 和 isLoading
    - 在检查认证状态时渲染加载指示器
    - 如果未认证则重定向到 /login
    - 为已认证用户渲染 Outlet
    - _需求: 4.1, 4.2, 4.3_
  
  - [ ]* 6.2 编写未认证路由保护的属性测试
    - **属性 8: 未认证路由保护**
    - **验证: 需求 4.1**
  
  - [ ]* 6.3 编写已认证路由访问的属性测试
    - **属性 9: 已认证路由访问**
    - **验证: 需求 4.2**
  
  - [ ]* 6.4 编写路由配置的属性测试
    - **属性 10: 路由配置保护**
    - **验证: 需求 4.4**

- [x] 7. 更新 App.tsx 路由
  - [x] 7.1 集成 ProtectedRoute 包装器
    - 添加 /login 路由作为公共路由
    - 用 ProtectedRoute 包装所有现有路由
    - 在 useEffect 中添加 AuthStore 初始化
    - _需求: 4.1, 4.4, 7.4_
  
  - [ ]* 7.2 编写路由的集成测试
    - 测试导航流程
    - 测试重定向行为
    - 测试认证初始化时机
    - _需求: 4.1, 4.2, 7.4_

- [x] 8. 实现用户资料管理
  - [x] 8.1 创建 ProfilePage 组件
    - 显示用户电子邮件（只读）
    - 添加名称和头像 URL 的表单
    - 使用 supabase.auth.updateUser() 实现资料更新
    - 显示成功/错误消息
    - _需求: 5.1, 5.2, 5.3, 5.5_
  
  - [ ]* 8.2 编写资料数据显示的属性测试
    - **属性 11: 资料数据显示**
    - **验证: 需求 5.1**
  
  - [ ]* 8.3 编写资料更新的属性测试
    - **属性 12: 资料更新持久化**
    - **验证: 需求 5.2, 5.3, 5.5**
  
  - [ ]* 8.4 编写 ProfilePage 的单元测试
    - 测试表单验证
    - 测试错误处理
    - 测试成功消息显示
    - _需求: 5.1, 5.2, 5.3, 10.5_

- [x] 9. 在侧边栏中实现用户菜单
  - [x] 9.1 创建 UserMenu 组件
    - 显示用户头像（从电子邮件首字母生成）
    - 显示用户名称或电子邮件
    - 添加包含资料和登出选项的下拉菜单
    - 实现登出按钮点击处理程序
    - _需求: 3.1, 3.2, 3.3, 8.1, 8.2, 8.3_
  
  - [ ]* 9.2 编写登出功能的属性测试
    - **属性 7: 登出清除会话**
    - **验证: 需求 3.1, 3.2, 3.3**
  
  - [ ]* 9.3 编写侧边栏用户显示的属性测试
    - **属性 18: 侧边栏用户显示**
    - **验证: 需求 8.1, 8.2**
  
  - [ ]* 9.4 编写用户菜单交互的属性测试
    - **属性 19: 用户菜单交互**
    - **验证: 需求 8.3**

- [x] 10. 将 UserMenu 集成到 Sidebar
  - [x] 10.1 更新 Sidebar 组件
    - 在侧边栏底部导入并渲染 UserMenu
    - 应用主题感知样式
    - 确保响应式布局
    - _需求: 8.1, 8.2, 8.3_
  
  - [ ]* 10.2 编写 Sidebar 的集成测试
    - 测试已认证时 UserMenu 的渲染
    - 测试未认证时 UserMenu 隐藏
    - _需求: 8.1, 8.2_

- [x] 11. 检查点 - 确保 UI 集成正常工作
  - 测试用户菜单显示和交互
  - 测试资料页面功能
  - 确保所有测试通过，如有问题请询问用户

- [x] 12. 实现数据库架构迁移
  - [x] 12.1 创建 SQL 迁移脚本
    - 向 diaries 表添加 user_id 列
    - 创建到 auth.users 的外键约束
    - 在 user_id 列上创建索引
    - 在 diaries 表上启用 RLS
    - 为 SELECT、INSERT、UPDATE、DELETE 创建 RLS 策略
    - _需求: 9.1, 9.2, 9.3, 9.4, 9.5_
  
  - [x] 12.2 记录迁移步骤
    - 在 docs/ 中创建迁移说明
    - 包含回滚程序
    - 添加验证查询
    - _需求: 9.1, 9.2, 9.3, 9.4, 9.5_

- [x] 13. 更新日记存储以支持多用户
  - [x] 13.1 修改 createDiary 函数
    - 从 Supabase Auth 获取当前用户
    - 向日记数据添加 user_id
    - 处理认证错误
    - _需求: 6.1_
  
  - [x] 13.2 更新 fetchDiaries 函数
    - 验证 RLS 自动按 user_id 过滤
    - 优雅地处理空结果
    - _需求: 6.2_
  
  - [ ]* 13.3 编写日记用户关联的属性测试
    - **属性 13: 日记用户关联**
    - **验证: 需求 6.1**
  
  - [ ]* 13.4 编写日记读取隔离的属性测试
    - **属性 14: 日记读取隔离**
    - **验证: 需求 6.2, 6.3**
  
  - [ ]* 13.5 编写日记写入隔离的属性测试
    - **属性 15: 日记写入隔离**
    - **验证: 需求 6.4, 6.5**

- [x] 14. 实现错误处理和用户反馈
  - [x] 14.1 创建错误映射工具
    - 将 Supabase 错误代码映射到用户友好的消息
    - 支持双语错误消息
    - _需求: 10.1, 10.2, 10.3_
  
  - [x] 14.2 添加错误显示组件
    - 创建 ErrorMessage 组件
    - 创建 SuccessMessage 组件
    - 实现自动关闭功能
    - _需求: 10.1, 10.5_
  
  - [ ]* 14.3 编写错误消息显示的属性测试
    - **属性 20: 错误消息显示**
    - **验证: 需求 10.1, 10.2, 10.3**
  
  - [ ]* 14.4 编写错误消息清除的属性测试
    - **属性 21: 错误消息清除**
    - **验证: 需求 10.4**
  
  - [ ]* 14.5 编写成功消息显示的属性测试
    - **属性 22: 成功消息显示**
    - **验证: 需求 10.5**

- [x] 15. 实现会话持久化
  - [x] 15.1 验证 Supabase 会话持久化
    - 测试会话在页面刷新后保持
    - 测试会话在浏览器重启后保持
    - 验证 localStorage 包含会话数据
    - _需求: 2.5_
  
  - [ ]* 15.2 编写会话持久化的属性测试
    - **属性 6: 会话持久化**
    - **验证: 需求 2.5**

- [x] 16. 最终集成和测试
  - [x] 16.1 运行完整测试套件
    - 执行所有单元测试
    - 执行所有基于属性的测试
    - 验证每个属性测试 100+ 次迭代
    - _需求: 全部_
  
  - [x] 16.2 手动测试清单
    - 端到端测试注册流程
    - 端到端测试登录流程
    - 端到端测试登出流程
    - 测试资料更新
    - 测试多用户数据隔离
    - 测试错误场景
    - 在不同浏览器上测试
    - 测试响应式设计
    - _需求: 全部_
  
  - [x] 16.3 性能测试
    - 测量登录时间（目标: < 1秒）
    - 测量注册时间（目标: < 2秒）
    - 测量路由保护检查（目标: < 100毫秒）
    - 测量带 RLS 的日记查询（目标: < 500毫秒）
    - _需求: 全部_

- [x] 17. 最终检查点 - 完整系统验证
  - 验证所有需求已满足
  - 验证所有测试通过
  - 验证文档完整
  - 确保所有测试通过，如有问题请询问用户

## 注意事项

- 标记为 `*` 的任务是可选的，可以跳过以加快 MVP 开发
- 每个任务都引用特定需求以便追溯
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边缘情况
- 数据库迁移（任务 12）应在 Supabase Dashboard SQL Editor 中执行
- 所有基于属性的测试应至少运行 100 次迭代
- 集成测试应覆盖完整的用户流程
- 手动测试对于 UX 验证至关重要
